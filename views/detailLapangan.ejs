<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= lapangan.nama_lapangan %> - Detail</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <i class="fas fa-futbol"></i>
                <span>Futsal Padang</span>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">Beranda</a>
                <% if (user) { %>
                    <span class="nav-user">
                        <i class="fas fa-user-circle"></i> <%= user.username %>
                    </span>
                    <% if (user.role === 'admin') { %>
                        <a href="/admin/dashboard" class="nav-link">Dashboard Admin</a>
                    <% } %>
                    <a href="/logout" class="btn btn-secondary">Logout</a>
                <% } else { %>
                    <a href="/login" class="btn btn-primary">Login</a>
                    <a href="/register" class="btn btn-secondary">Register</a>
                <% } %>
            </div>
        </div>
    </nav>

    <!-- Detail Content -->
    <div class="detail-container">
        <div class="detail-content">
            <div class="detail-header">
                <h1><%= lapangan.nama_lapangan %></h1>
                <div class="rating-large">
                    <i class="fas fa-star"></i>
                    <span class="rating-value"><%= parseFloat(lapangan.avg_rating).toFixed(1) %></span>
                    <span class="rating-count">(<%= lapangan.total_reviews %> ulasan)</span>
                </div>
            </div>

            <div class="detail-info">
                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <div>
                        <strong>Alamat</strong>
                        <p><%= lapangan.alamat %></p>
                    </div>
                </div>

                <div class="info-item">
                    <i class="fas fa-tag"></i>
                    <div>
                        <strong>Harga Sewa</strong>
                        <p>Rp <%= lapangan.harga_sewa.toLocaleString('id-ID') %>/jam</p>
                    </div>
                </div>

                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <div>
                        <strong>Jam Operasional</strong>
                        <p><%= lapangan.jam_operasional || 'Hubungi untuk info lebih lanjut' %></p>
                    </div>
                </div>

                <div class="info-item">
                    <i class="fas fa-phone"></i>
                    <div>
                        <strong>Telepon</strong>
                        <p><%= lapangan.telepon || '-' %></p>
                    </div>
                </div>
            </div>

            <!-- Gallery Foto -->
            <div class="detail-section">
                <h2><i class="fas fa-images"></i> Galeri Foto</h2>
                <div id="photoGalleryUser" class="user-photo-gallery">
                    <p class="text-center">Loading...</p>
                </div>
            </div>

            <div class="detail-section">
                <h2><i class="fas fa-info-circle"></i> Deskripsi</h2>
                <p><%= lapangan.deskripsi || 'Tidak ada deskripsi.' %></p>
            </div>

            <div class="detail-section">
                <h2><i class="fas fa-check-circle"></i> Fasilitas</h2>
                <p><%= lapangan.fasilitas || 'Tidak ada informasi fasilitas.' %></p>
            </div>

            <!-- Peta Lokasi -->
            <div class="detail-section">
                <h2><i class="fas fa-map"></i> Lokasi</h2>
                <div id="detailMap" style="height: 400px; border-radius: 8px;"></div>
            </div>

            <!-- Rating dan Ulasan -->
            <div class="detail-section">
                <h2><i class="fas fa-star"></i> Rating & Ulasan</h2>

                <% if (user) { %>
                    <div class="rating-form">
                        <h3>
                            <% if (userRating) { %>
                                <i class="fas fa-edit"></i> Edit Rating Anda
                            <% } else { %>
                                <i class="fas fa-star"></i> Berikan Rating Anda
                            <% } %>
                        </h3>
                        <% if (userRating) { %>
                            <div class="alert-info">
                                <i class="fas fa-info-circle"></i>
                                Anda sudah memberikan rating sebelumnya. Anda dapat mengubahnya di bawah ini.
                            </div>
                        <% } %>
                        <form id="ratingForm">
                            <input type="hidden" name="lapangan_id" value="<%= lapangan.id %>">
                            <div class="star-rating" id="starRating">
                                <input type="radio" name="rating" value="5" id="star5" <%= userRating && userRating.rating === 5 ? 'checked' : '' %>>
                                <label for="star5"><i class="fas fa-star"></i></label>
                                <input type="radio" name="rating" value="4" id="star4" <%= userRating && userRating.rating === 4 ? 'checked' : '' %>>
                                <label for="star4"><i class="fas fa-star"></i></label>
                                <input type="radio" name="rating" value="3" id="star3" <%= userRating && userRating.rating === 3 ? 'checked' : '' %>>
                                <label for="star3"><i class="fas fa-star"></i></label>
                                <input type="radio" name="rating" value="2" id="star2" <%= userRating && userRating.rating === 2 ? 'checked' : '' %>>
                                <label for="star2"><i class="fas fa-star"></i></label>
                                <input type="radio" name="rating" value="1" id="star1" <%= userRating && userRating.rating === 1 ? 'checked' : '' %>>
                                <label for="star1"><i class="fas fa-star"></i></label>
                            </div>
                            <textarea name="ulasan" placeholder="Tulis ulasan Anda (opsional)" rows="3"><%= userRating ? userRating.ulasan : '' %></textarea>
                            <button type="submit" class="btn btn-primary">
                                <% if (userRating) { %>
                                    <i class="fas fa-save"></i> Update Rating
                                <% } else { %>
                                    <i class="fas fa-paper-plane"></i> Kirim Rating
                                <% } %>
                            </button>
                        </form>
                    </div>
                <% } else { %>
                    <p class="login-prompt">
                        <a href="/login">Login</a> untuk memberikan rating dan ulasan
                    </p>
                <% } %>

                <div class="reviews-list">
                    <% if (ratings && ratings.length > 0) { %>
                        <% ratings.forEach(function(rating) { %>
                            <div class="review-item">
                                <div class="review-header">
                                    <div>
                                        <strong><i class="fas fa-user-circle"></i> <%= rating.username %></strong>
                                        <div class="review-rating">
                                            <% for(let i = 1; i <= 5; i++) { %>
                                                <i class="fas fa-star <%= i <= rating.rating ? 'active' : '' %>"></i>
                                            <% } %>
                                        </div>
                                    </div>
                                    <span class="review-date"><%= new Date(rating.created_at).toLocaleDateString('id-ID') %></span>
                                </div>
                                <% if (rating.ulasan) { %>
                                    <p class="review-text"><%= rating.ulasan %></p>
                                <% } %>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <p class="no-reviews">Belum ada ulasan untuk lapangan ini.</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Inisialisasi peta detail
        const detailMap = L.map('detailMap').setView([<%= lapangan.latitude %>, <%= lapangan.longitude %>], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(detailMap);

        // Marker untuk lokasi lapangan
        const marker = L.marker([<%= lapangan.latitude %>, <%= lapangan.longitude %>]).addTo(detailMap);
        marker.bindPopup('<strong><%= lapangan.nama_lapangan %></strong><br><%= lapangan.alamat %>').openPopup();

        // Star Rating Animation
        const starRating = document.getElementById('starRating');
        if (starRating) {
            const labels = starRating.querySelectorAll('label');
            const inputs = starRating.querySelectorAll('input[type="radio"]');

            // Function to update star colors based on rating
            function updateStars(rating) {
                labels.forEach((label) => {
                    const inputId = label.getAttribute('for');
                    const input = document.getElementById(inputId);
                    const starValue = parseInt(input.value);
                    
                    // Only use class, remove inline styles
                    if (starValue <= rating) {
                        label.classList.add('active');
                    } else {
                        label.classList.remove('active');
                    }
                });
            }

            // Set initial state if there's already a rating
            const checkedInput = starRating.querySelector('input[type="radio"]:checked');
            if (checkedInput) {
                updateStars(parseInt(checkedInput.value));
            }

            // Add click event to each label
            labels.forEach((label) => {
                label.addEventListener('click', function() {
                    const inputId = this.getAttribute('for');
                    const input = document.getElementById(inputId);
                    input.checked = true;
                    const rating = parseInt(input.value);
                    updateStars(rating);
                });
            });

            // Add hover effect
            labels.forEach((label) => {
                label.addEventListener('mouseenter', function() {
                    const inputId = this.getAttribute('for');
                    const input = document.getElementById(inputId);
                    const rating = parseInt(input.value);
                    updateStars(rating);
                });
            });

            // Reset on mouse leave to checked value
            starRating.addEventListener('mouseleave', function() {
                const checkedInput = starRating.querySelector('input[type="radio"]:checked');
                if (checkedInput) {
                    updateStars(parseInt(checkedInput.value));
                } else {
                    updateStars(0); // Reset to gray if nothing selected
                }
            });
        }

        // Handle rating form submission
        <% if (user) { %>
        document.getElementById('ratingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            // Validasi rating harus dipilih
            if (!data.rating) {
                alert('Silakan pilih rating bintang terlebih dahulu!');
                return;
            }

            try {
                const response = await fetch('/api/rating', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    <% if (userRating) { %>
                        alert('Rating berhasil diupdate!');
                    <% } else { %>
                        alert('Rating berhasil disimpan!');
                    <% } %>
                    location.reload();
                } else {
                    alert(result.message || 'Gagal menyimpan rating');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan');
            }
        });
        <% } %>

        // Load photo gallery
        loadPhotoGallery();

        async function loadPhotoGallery() {
            try {
                const response = await fetch('/api/photos/lapangan/<%= lapangan.id %>');
                const result = await response.json();
                
                const gallery = document.getElementById('photoGalleryUser');
                
                if (result.success && result.data.length > 0) {
                    gallery.innerHTML = '';
                    result.data.forEach(photo => {
                        const photoItem = document.createElement('div');
                        photoItem.className = 'user-photo-item';
                        photoItem.innerHTML = `
                            <img src="${photo.photo_url}" alt="${photo.caption || 'Foto lapangan'}" onclick="openPhotoModal('${photo.photo_url}')">
                            ${photo.is_primary ? '<span class="photo-primary-badge"><i class="fas fa-star"></i> Utama</span>' : ''}
                            ${photo.caption ? `<p class="photo-caption">${photo.caption}</p>` : ''}
                        `;
                        gallery.appendChild(photoItem);
                    });
                } else {
                    gallery.innerHTML = '<p class="text-center" style="color: #999; padding: 2rem;">Belum ada foto untuk lapangan ini</p>';
                }
            } catch (error) {
                console.error('Error loading photos:', error);
                document.getElementById('photoGalleryUser').innerHTML = '<p class="text-center" style="color: red;">Gagal memuat foto</p>';
            }
        }

        function openPhotoModal(photoUrl) {
            const modal = document.createElement('div');
            modal.className = 'lightbox-modal';
            modal.innerHTML = `
                <div class="lightbox-content">
                    <span class="lightbox-close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <img src="${photoUrl}" alt="Foto lapangan">
                </div>
            `;
            modal.onclick = function(e) {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>

